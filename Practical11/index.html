<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatter ‚Äî Social Chat App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0b1020;
        --panel: #121735;
        --muted: #93a5fd;
        --text: #e8eeff;
        --accent: #6c7cff;
        --accent-2: #16db65;
        --danger: #ff5c7a;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        background: linear-gradient(120deg, #0b1020, #141a3f);
        color: var(--text);
        font-family: Inter, system-ui, sans-serif;
      }
      .app {
        display: grid;
        grid-template-columns: 280px 1fr;
        min-height: 100vh;
      }
      .sidebar {
        background: rgba(18, 23, 53, 0.7);
        backdrop-filter: blur(8px);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
      }
      .logo .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent-2);
        box-shadow: 0 0 18px var(--accent-2);
      }
      .card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
      }
      .user-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
      }
      .user-card img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
      }
      .btn {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
        cursor: pointer;
        font-family: inherit;
      }
      .btn.primary {
        background: var(--accent);
        border-color: transparent;
      }
      .btn.full {
        width: 100%;
      }
      .search {
        display: flex;
        gap: 8px;
        padding: 10px;
      }
      .search input {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        font-family: inherit;
      }
      .nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px;
      }
      .nav .item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
      }
      .nav .item.active,
      .nav .item:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .chats {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 8px;
        overflow: auto;
      }
      .chat-row {
        display: grid;
        grid-template-columns: 46px 1fr auto;
        gap: 10px;
        padding: 10px;
        border-radius: 12px;
        cursor: pointer;
      }
      .chat-row:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      .chat-row img {
        width: 46px;
        height: 46px;
        border-radius: 50%;
      }
      .chat-row .name {
        font-weight: 600;
      }
      .chat-row .last {
        color: #b7bde3;
        font-size: 0.92rem;
      }
      .main {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(18, 23, 53, 0.6);
        backdrop-filter: blur(8px);
      }
      .content {
        display: grid;
        grid-template-rows: 1fr auto;
        gap: 0;
        height: calc(100vh - 56px);
      }
      .messages {
        padding: 14px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .bubble {
        max-width: 70%;
        padding: 10px 12px;
        border-radius: 14px;
        line-height: 1.35;
      }
      .me {
        align-self: flex-end;
        background: linear-gradient(135deg, var(--accent), #8e99ff);
      }
      .you {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.08);
      }
      .composer {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.15);
      }
      .composer textarea {
        resize: none;
        height: 50px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        font-family: inherit;
      }
      .auth {
        max-width: 420px;
        margin: 8vh auto;
        padding: 20px;
      }
      .auth .group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin: 8px 0;
      }
      .auth input {
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
        font-family: inherit;
      }
      .empty {
        display: grid;
        place-items: center;
        height: 100%;
        color: #aeb7e9;
      }
      .pill {
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px dashed rgba(255, 255, 255, 0.18);
      }
      .muted {
        color: #a8b0d6;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div id="authView" class="auth card" hidden>
      <div class="logo" style="margin-bottom: 12px">
        <span class="dot"></span> <span>Chatter</span>
      </div>
      <h2 id="authTitle">Create account</h2>
      <div class="group">
        <label>Name</label><input id="nameInput" placeholder="Your Name" />
      </div>
      <div class="group">
        <label>Email</label><input id="emailInput" type="email" placeholder="your@email.com" />
      </div>
      <div class="group">
        <label>Password</label><input id="passwordInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div class="group">
        <button class="btn primary full" id="authSubmit">Sign up</button>
      </div>
      <div class="group">
        <button class="btn full" id="googleBtn">Continue with Google</button>
      </div>
      <div style="margin-top: 6px; font-size: 0.95rem;">
        <span id="authSwitch">Already have an account? <a href="#" id="toLogin">Sign in</a></span>
      </div>
    </div>

    <div id="appView" class="app" hidden>
      <aside class="sidebar">
        <div class="logo"><span class="dot"></span><span>Chatter</span></div>
        
        <div class="card user-card">
          <img id="myAvatar" src="https://api.dicebear.com/9.x/thumbs/svg?seed=me" alt="me" />
          <div>
            <div id="myName" style="font-weight: 600">Loading...</div>
            <div id="myEmail" class="muted">Loading...</div>
          </div>
        </div>

        <div class="card search">
          <input id="userSearch" placeholder="Search users by name/email" />
          <button class="btn" id="searchBtn">üîç</button>
        </div>

        <div class="nav card">
          <div class="item active" id="navChats">üí¨ Chats</div>
          <div class="item" id="navPeople">üë• People</div>
          <div class="item" id="navProfile">üôç Profile</div>
          <div class="item" id="navLogout">üö™ Logout</div>
        </div>

        <div class="card" style="padding: 8px">
          <div class="muted" style="padding: 8px 8px 0">Content</div>
          <div class="chats" id="contentList"></div>
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div>
            <strong id="chatTitle">Welcome to Chatter</strong>
            <div id="chatSub" class="muted">Select a chat or find people to start messaging</div>
          </div>
        </div>

        <div class="content">
          <div class="messages" id="messages"></div>
          <div class="composer" id="composer" hidden>
            <textarea id="messageInput" placeholder="Type a message‚Ä¶"></textarea>
            <button class="btn primary" id="sendBtn">Send</button>
          </div>
          <div class="empty" id="emptyState">
            <div class="pill">Select a chat to start messaging</div>
          </div>
        </div>
      </main>
    </div>

    <script type="module">
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyA2IB_NUKJxSf4Objqbzq6yUMHTlUi05VY",
        authDomain: "practical-11-f5ea7.firebaseapp.com",
        projectId: "practical-11-f5ea7",
        storageBucket: "practical-11-f5ea7.firebasestorage.app",
        messagingSenderId: "445678607788",
        appId: "1:445678607788:web:b2a47d880a2cc45876ee09",
        measurementId: "G-CY67KM405B"
      };

      // Firebase Imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        updateProfile,
        GoogleAuthProvider,
        signInWithPopup,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        addDoc,
        collection,
        getDocs,
        serverTimestamp,
        onSnapshot,
        orderBy,
        updateDoc,
        query
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const googleProvider = new GoogleAuthProvider();

      console.log('Firebase initialized for project:', firebaseConfig.projectId);

      // DOM Elements
      const authView = document.getElementById("authView");
      const appView = document.getElementById("appView");
      const authTitle = document.getElementById("authTitle");
      const nameInput = document.getElementById("nameInput");
      const emailInput = document.getElementById("emailInput");
      const passwordInput = document.getElementById("passwordInput");
      const authSubmit = document.getElementById("authSubmit");
      const googleBtn = document.getElementById("googleBtn");
      const toLogin = document.getElementById("toLogin");

      const myName = document.getElementById("myName");
      const myEmail = document.getElementById("myEmail");
      const myAvatar = document.getElementById("myAvatar");
      const userSearch = document.getElementById("userSearch");
      const searchBtn = document.getElementById("searchBtn");
      const contentList = document.getElementById("contentList");
      const navChats = document.getElementById("navChats");
      const navPeople = document.getElementById("navPeople");
      const navProfile = document.getElementById("navProfile");
      const navLogout = document.getElementById("navLogout");
      const chatTitle = document.getElementById("chatTitle");
      const chatSub = document.getElementById("chatSub");
      const messages = document.getElementById("messages");
      const composer = document.getElementById("composer");
      const emptyState = document.getElementById("emptyState");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");

      // State Variables
      let isSignupMode = true;
      let currentMode = 'chats';
      let currentUser = null;
      let activeChatId = null;
      let messagesUnsubscribe = null;
      let chatsUnsubscribe = null;

      // Helper Functions
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      function debounce(func, delay) {
        let timeoutId;
        return (...args) => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
      }

      function timeAgo(date) {
        if (!date) return '';
        const now = new Date();
        const diff = Math.floor((now - date.toDate()) / 1000);
        if (diff < 60) return 'now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h';
        return Math.floor(diff / 86400) + 'd';
      }

      // Auth Functions
      function toggleAuthMode() {
        isSignupMode = !isSignupMode;
        authTitle.textContent = isSignupMode ? "Create account" : "Welcome back";
        authSubmit.textContent = isSignupMode ? "Sign up" : "Sign in";
        nameInput.parentElement.style.display = isSignupMode ? "flex" : "none";
        document.getElementById("authSwitch").innerHTML = isSignupMode
          ? 'Already have an account? <a href="#" id="toLogin">Sign in</a>'
          : 'Don\'t have an account? <a href="#" id="toSignup">Create one</a>';
        
        // Re-attach event listener
        const switchLink = document.querySelector('#authSwitch a');
        switchLink.addEventListener('click', (e) => {
          e.preventDefault();
          toggleAuthMode();
        });
      }

      async function handleAuth() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        const name = nameInput.value.trim();

        if (!email || !password) {
          alert("Please fill in all required fields");
          return;
        }

        if (isSignupMode && !name) {
          alert("Please enter your name");
          return;
        }

        try {
          authSubmit.textContent = "Loading...";
          authSubmit.disabled = true;

          let userCredential;
          if (isSignupMode) {
            userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, {
              displayName: name,
              photoURL: `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(name)}`
            });
          } else {
            userCredential = await signInWithEmailAndPassword(auth, email, password);
          }

          await createUserDocument(userCredential.user);
          console.log('Authentication successful');
        } catch (error) {
          console.error('Auth error:', error);
          alert('Authentication failed: ' + error.message);
        } finally {
          authSubmit.textContent = isSignupMode ? "Sign up" : "Sign in";
          authSubmit.disabled = false;
        }
      }

      async function handleGoogleAuth() {
        try {
          googleBtn.textContent = "Loading...";
          googleBtn.disabled = true;
          const result = await signInWithPopup(auth, googleProvider);
          await createUserDocument(result.user);
          console.log('Google authentication successful');
        } catch (error) {
          console.error('Google auth error:', error);
          alert('Google authentication failed: ' + error.message);
        } finally {
          googleBtn.textContent = "Continue with Google";
          googleBtn.disabled = false;
        }
      }

      async function createUserDocument(user) {
        try {
          const userRef = doc(db, "users", user.uid);
          const userSnap = await getDoc(userRef);
          
          const userData = {
            uid: user.uid,
            name: user.displayName || user.email.split('@')[0],
            email: user.email,
            photoURL: user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(user.uid)}`,
            lastSeen: serverTimestamp(),
            isOnline: true
          };

          if (!userSnap.exists()) {
            userData.createdAt = serverTimestamp();
            await setDoc(userRef, userData);
            console.log('User document created:', userData);
          } else {
            await updateDoc(userRef, {
              lastSeen: serverTimestamp(),
              isOnline: true,
              name: userData.name,
              photoURL: userData.photoURL
            });
            console.log('User document updated');
          }
          
          if (currentMode === 'people') {
            setTimeout(() => loadPeople(), 1000);
          }
        } catch (error) {
          console.error('Error creating/updating user document:', error);
        }
      }

      function setMode(mode) {
        currentMode = mode;
        console.log('Setting mode to:', mode);
        
        document.querySelectorAll('.nav .item').forEach(item => item.classList.remove('active'));
        document.getElementById(`nav${mode.charAt(0).toUpperCase() + mode.slice(1)}`).classList.add('active');

        contentList.innerHTML = "";

        if (mode === 'chats') {
          loadChats();
        } else if (mode === 'people') {
          loadPeople();
          userSearch.value = '';
        } else if (mode === 'profile') {
          showProfile();
        }
      }

      function loadChats() {
        if (!currentUser) return;
        
        if (chatsUnsubscribe) chatsUnsubscribe();
        
        const chatsRef = collection(db, "userChats", currentUser.uid, "items");
        const q = query(chatsRef, orderBy("updatedAt", "desc"));
        
        chatsUnsubscribe = onSnapshot(q, (snapshot) => {
          contentList.innerHTML = "";
          
          if (snapshot.empty) {
            contentList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No chats yet.<br><button class="btn" onclick="setMode(\'people\')" style="margin-top: 10px; background: var(--accent); color: white;">Find People</button></div>';
            return;
          }

          snapshot.forEach((doc) => {
            const chat = doc.data();
            const chatElement = document.createElement('div');
            chatElement.className = 'chat-row';
            chatElement.innerHTML = `
              <img src="${chat.otherPhoto || 'https://api.dicebear.com/9.x/thumbs/svg?seed=user'}" alt="${chat.otherName}">
              <div>
                <div class="name">${escapeHtml(chat.otherName || 'User')}</div>
                <div class="last">${escapeHtml(chat.lastMessage || 'Say hello!')}</div>
              </div>
              <div class="muted">${timeAgo(chat.updatedAt)}</div>
            `;
            
            chatElement.addEventListener('click', () => openChat(chat.chatId, chat));
            contentList.appendChild(chatElement);
          });
        });
      }

      async function loadPeople() {
        try {
          contentList.innerHTML = '<div style="padding: 20px; text-align: center;">üîç Loading users...</div>';
          
          const usersRef = collection(db, "users");
          const snapshot = await getDocs(usersRef);
          
          console.log('Total users in database:', snapshot.size);
          
          contentList.innerHTML = "";
          
          if (snapshot.empty) {
            contentList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No users found. Create more accounts to see them here!</div>';
            return;
          }

          let userCount = 0;
          snapshot.forEach((doc) => {
            const user = doc.data();
            console.log('User found:', user.name, user.email, user.uid);
            
            if (user.uid === currentUser?.uid) return;

            userCount++;
            const userElement = document.createElement('div');
            userElement.className = 'chat-row';
            userElement.innerHTML = `
              <img src="${user.photoURL || 'https://api.dicebear.com/9.x/thumbs/svg?seed=user'}" alt="${user.name || 'User'}">
              <div>
                <div class="name">${escapeHtml(user.name || 'User')} ${user.isOnline ? 'üü¢' : 'üî¥'}</div>
                <div class="last">${escapeHtml(user.email || '')}</div>
              </div>
              <div>
                <button class="btn" style="background: var(--accent); color: white; font-size: 12px;">üí¨ Chat</button>
              </div>
            `;
            
            userElement.querySelector('button').addEventListener('click', (e) => {
              e.stopPropagation();
              console.log('Starting chat with:', user.name, user.uid);
              startChatWith(user.uid);
            });
            
            contentList.appendChild(userElement);
          });

          if (userCount === 0) {
            contentList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No other users found. Create more accounts to chat!</div>';
          } else {
            console.log('Rendered', userCount, 'users');
          }
        } catch (error) {
          console.error('Error loading people:', error);
          contentList.innerHTML = '<div style="padding: 20px; color: var(--danger);">Error loading users: ' + error.message + '</div>';
        }
      }

      function showProfile() {
        if (!currentUser) return;
        
        contentList.innerHTML = `
          <div class="chat-row" style="grid-template-columns: 56px 1fr;">
            <img src="${currentUser.photoURL || 'https://api.dicebear.com/9.x/thumbs/svg?seed=me'}" alt="me">
            <div>
              <div class="name">${escapeHtml(currentUser.displayName || 'Anonymous')}</div>
              <div class="last">${escapeHtml(currentUser.email || '')}</div>
            </div>
          </div>
          <div style="padding: 20px; text-align: center;">
            <button class="btn" onclick="handleLogout()" style="background: var(--danger); color: white;">Sign Out</button>
          </div>
        `;
      }

      async function startChatWith(otherUserId) {
        if (!currentUser || currentUser.uid === otherUserId) return;

        try {
          const chatId = [currentUser.uid, otherUserId].sort().join('_');
          
          const chatRef = doc(db, "chats", chatId);
          const chatSnap = await getDoc(chatRef);
          
          if (!chatSnap.exists()) {
            await setDoc(chatRef, {
              chatId,
              participants: [currentUser.uid, otherUserId],
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
              lastMessage: ""
            });
          }

          const otherUserRef = doc(db, "users", otherUserId);
          const otherUserSnap = await getDoc(otherUserRef);
          const otherUser = otherUserSnap.data();

          await setDoc(doc(db, "userChats", currentUser.uid, "items", chatId), {
            chatId,
            otherUid: otherUserId,
            otherName: otherUser.name,
            otherPhoto: otherUser.photoURL,
            lastMessage: "",
            updatedAt: serverTimestamp()
          }, { merge: true });

          await setDoc(doc(db, "userChats", otherUserId, "items", chatId), {
            chatId,
            otherUid: currentUser.uid,
            otherName: currentUser.displayName,
            otherPhoto: currentUser.photoURL,
            lastMessage: "",
            updatedAt: serverTimestamp()
          }, { merge: true });

          setMode('chats');
          setTimeout(() => openChat(chatId, {
            otherUid: otherUserId,
            otherName: otherUser.name,
            otherPhoto: otherUser.photoURL
          }), 500);

        } catch (error) {
          console.error('Error starting chat:', error);
          alert('Failed to start chat: ' + error.message);
        }
      }

      function openChat(chatId, chatData) {
        activeChatId = chatId;
        chatTitle.textContent = chatData.otherName || 'Chat';
        chatSub.textContent = 'Online';
        
        emptyState.hidden = true;
        composer.hidden = false;
        messages.innerHTML = "";

        if (messagesUnsubscribe) messagesUnsubscribe();
        
        const messagesRef = collection(db, "chats", chatId, "messages");
        const q = query(messagesRef, orderBy("createdAt", "asc"));
        
        messagesUnsubscribe = onSnapshot(q, (snapshot) => {
          messages.innerHTML = "";
          
          snapshot.forEach((doc) => {
            const message = doc.data();
            const messageElement = document.createElement('div');
            messageElement.className = `bubble ${message.senderId === currentUser.uid ? 'me' : 'you'}`;
            messageElement.textContent = message.text;
            messages.appendChild(messageElement);
          });
          
          messages.scrollTop = messages.scrollHeight;
        });
      }

      async function sendMessage() {
        if (!activeChatId || !currentUser) return;

        const text = messageInput.value.trim();
        if (!text) return;

        try {
          messageInput.value = "";
          sendBtn.disabled = true;

          const messagesRef = collection(db, "chats", activeChatId, "messages");
          await addDoc(messagesRef, {
            text,
            senderId: currentUser.uid,
            createdAt: serverTimestamp()
          });

          await updateDoc(doc(db, "chats", activeChatId), {
            lastMessage: text,
            updatedAt: serverTimestamp()
          });

          const [uid1, uid2] = activeChatId.split('_');
          await updateDoc(doc(db, "userChats", uid1, "items", activeChatId), {
            lastMessage: text,
            updatedAt: serverTimestamp()
          });
          await updateDoc(doc(db, "userChats", uid2, "items", activeChatId), {
            lastMessage: text,
            updatedAt: serverTimestamp()
          });

        } catch (error) {
          console.error('Error sending message:', error);
          alert('Failed to send message');
        } finally {
          sendBtn.disabled = false;
        }
      }

      async function handleLogout() {
        try {
          if (currentUser) {
            await updateDoc(doc(db, "users", currentUser.uid), {
              isOnline: false,
              lastSeen: serverTimestamp()
            });
          }
          await signOut(auth);
        } catch (error) {
          console.error('Logout error:', error);
        }
      }

      // Enhanced search functionality
      const debouncedSearch = debounce(async (searchTerm) => {
        if (currentMode !== 'people') return;
        
        try {
          console.log('Searching for:', searchTerm);
          contentList.innerHTML = '<div style="padding: 20px; text-align: center;">üîç Searching...</div>';
          
          const usersRef = collection(db, "users");
          const snapshot = await getDocs(usersRef);
          
          contentList.innerHTML = "";
          let found = false;

          snapshot.forEach((doc) => {
            const user = doc.data();
            if (user.uid === currentUser?.uid) return;

            const searchLower = searchTerm.toLowerCase();
            const matchesSearch = !searchTerm || 
              (user.name && user.name.toLowerCase().includes(searchLower)) || 
              (user.email && user.email.toLowerCase().includes(searchLower));

            if (matchesSearch) {
              found = true;
              const userElement = document.createElement('div');
              userElement.className = 'chat-row';
              userElement.innerHTML = `
                <img src="${user.photoURL || 'https://api.dicebear.com/9.x/thumbs/svg?seed=user'}" alt="${user.name || 'User'}">
                <div>
                  <div class="name">${escapeHtml(user.name || 'User')} ${user.isOnline ? 'üü¢' : 'üî¥'}</div>
                  <div class="last">${escapeHtml(user.email || '')}</div>
                </div>
                <div>
                  <button class="btn" style="background: var(--accent); color: white; font-size: 12px;">üí¨ Chat</button>
                </div>
              `;
              
              userElement.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                startChatWith(user.uid);
              });
              
              contentList.appendChild(userElement);
            }
          });

          if (!found) {
            contentList.innerHTML = `<div style="padding: 20px; text-align: center; color: #888;">No users found for "${escapeHtml(searchTerm)}"<br><small>Try different search terms</small></div>`;
          }
        } catch (error) {
          console.error('Search error:', error);
          contentList.innerHTML = '<div style="padding: 20px; color: var(--danger);">Search failed: ' + error.message + '</div>';
        }
      }, 300);

      // Event Listeners
      authSubmit.addEventListener('click', handleAuth);
      googleBtn.addEventListener('click', handleGoogleAuth);
      toLogin.addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthMode();
      });

      navChats.addEventListener('click', () => setMode('chats'));
      navPeople.addEventListener('click', () => setMode('people'));
      navProfile.addEventListener('click', () => setMode('profile'));
      navLogout.addEventListener('click', handleLogout);

      userSearch.addEventListener('input', (e) => {
        const term = e.target.value.trim();
        console.log('Search input changed:', term);
        debouncedSearch(term);
      });

      searchBtn.addEventListener('click', () => {
        console.log('Search button clicked, current mode:', currentMode);
        if (currentMode === 'people') {
          userSearch.value = '';
          loadPeople();
        } else {
          setMode('people');
        }
      });

      sendBtn.addEventListener('click', sendMessage);
      messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      userSearch.addEventListener('focus', () => {
        if (currentMode === 'people' && !userSearch.value) {
          loadPeople();
        }
      });

      // Auth State Observer
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          authView.hidden = true;
          appView.hidden = false;
          
          // Fix the "Loading..." issue by properly setting user info
          myName.textContent = user.displayName || user.email?.split('@')[0] || 'Anonymous';
          myEmail.textContent = user.email || '';
          myAvatar.src = user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(user.uid)}`;
          
          setMode('chats');
          console.log('User signed in:', user.email);
        } else {
          currentUser = null;
          authView.hidden = false;
          appView.hidden = true;
          
          if (messagesUnsubscribe) messagesUnsubscribe();
          if (chatsUnsubscribe) chatsUnsubscribe();
          
          console.log('User signed out');
        }
      });

      // Global functions for inline handlers
      window.setMode = setMode;
      window.handleLogout = handleLogout;

      console.log('Chatter app initialized');
    </script>
  </body>
</html>
